<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반도체 생산라인 관리</title>

    <!-- Favicon and Styles from Original Layout -->
    <link rel="icon" type="image/x-icon" th:href="@{/assets/favicon.ico}" />
    <link th:href="@{/css/linestyles.css}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar-->
    <!-- Sidebar-->
    <div class="border-end bg-light" id="sidebar-wrapper" style="background-color: #e3f2fd !important;">
        <div class="sidebar-heading border-bottom custom-sidebar-heading" style="text-align: center; height: 10vh;">
            <a class="a-tag" th:href="@{/bio/dashboard}"><h1>SemiCon</h1></a>
        </div>
        <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action list-group-item-light p-3"
               th:href="@{/process/list}">생산관리 모니터링</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" th:href="@{/product/list}">제품관리</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" th:href="@{/plan/list}">생산계획관리</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" th:href="@{/line/list}">생산라인관리</a>

            <div th:if="${isAdmin}">
                <a class="list-group-item list-group-item-action list-group-item-light p-3" th:onclick="location.href='/admin'">관리자 페이지</a>
            </div>

            <div class="company-information">
                <p><b>Bio One</b></p>
                <p><b>경기도 성남시 분당구 190번길 45</b></p>
                <p><b>Tel : 031-250-8900</b></p>
                <p><b>Fax : 031-250-8901</b></p>
                <p><b>사업자등록번호 : 111-23-45678</b></p>
            </div>
        </div>
    </div>
    <!-- Page content wrapper-->
    <div id="page-content-wrapper">
        <!-- Top navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <!--<button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>-->

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                    </ul>
                </div>
                <!-- login 관련 추가 -->
                <div class="loginInfo">
                    <div class="login" th:if="${user == null}">
                        <button th:onclick="location.href='/bio/login'">로그인</button>
                    </div>
                    <div class="logout" th:unless="${user == null}">
                        <h6>[[${employeeName}]]님 환영합니다.</h6>
                        <button th:onclick="location.href='/bio/logout'">로그아웃</button>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Page content-->
        <!-- Integrated Production Plan Content -->
        <div class="container-fluid" layout:fragment="content">
            <div class="container">
                <!-- 생산계획 목록 섹션 -->
                <div class="section-title">생산라인 목록</div>

                <!-- 검색 및 필터 영역 -->
                <form th:action="@{/line/search}" method="get" class="search-bar">
                    <label for="search">검색:</label>
                    <input type="text" id="search" name="keyword" placeholder="검색어 입력" th:value="${keyword}">

                    <select name="status" class="dropdown">
                        <option value="">LINE</option>
                        <option value="생산 라인 1" th:selected="${selectedProductionLineName == '생산 라인 1'}">생산 라인 1</option>
                        <option value="생산 라인 2" th:selected="${selectedProductionLineName == '생산 라인 2'}">생산 라인 2</option>
                        <option value="생산 라인 3" th:selected="${selectedProductionLineName == '생산 라인 3'}">생산 라인 3</option>
                    </select>

                    <select name="status" class="dropdown">
                        <option value="">STATUS</option>
                        <option value="NORMAL" th:selected="${selectedStatus == 'NORMAL'}">NORMAL</option>
                        <option value="DEFECTED" th:selected="${selectedStatus == 'DEFECTED'}">DEFECTED</option>
                    </select>

                    <button type="submit" class="button">검색</button>
                </form>

                <!-- 생산라인 테이블 -->
                <table th:if="${!lines.empty}" class="board-table">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th data-column="productionLineCode" class="sortable">코드</th>
                        <th data-column="productionLineName" class="sortable">라인명</th>
                        <th data-column="location" class="sortable">위치</th>
                        <th data-column="manager" class="sortable">담당자</th>
                        <th data-column="capacity" class="sortable">용량</th>
                        <th data-column="equipment" class="sortable">설비정보</th>
                        <th data-column="todayQty" class="sortable">금일목표수량</th>
                        <th data-column="achievedQty" class="sortable">달성수량</th>
                        <th data-column="productLineStatus" class="sortable">상태</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="line, iterStat : ${lines.content}">
                        <td><input type="checkbox" name="selectedLine" th:value="${line.productionLineCode}" class="lineCheckbox"></td>
                        <td th:text="${iterStat.count + (lines.number * lines.size)}"></td>
                        <td><span th:text="${line.productionLineName}"></span></td>
                        <td th:text="${line.location}"></td>
                        <td th:text="${line.manager}"></td>
                        <td th:text="${line.capacity}"></td>
                        <th th:text="${line.equipment}"></th>
                        <td th:text="${line.todayQty}"></td>
                        <td th:text="${line.achievedQty}"></td>
                        <td th:text="${line.productionLineStatus}"></td>
                        <td class="action-btn">
                            <button class="button" th:data-production-line-code="${line.productionLineCode}" onclick="openModifyModal(this.getAttribute('data-production-line-code'))">수정</button>
                            <!--                            <form th:action="@{/plan/delete/{id}(id=${plan.planId})}" method="post" style="display: inline;">-->
                            <!--                                <button type="submit" class="button delete"-->
                            <!--                                        onclick="return confirm('정말 삭제하시겠습니까? 삭제된 데이터는 복구할 수 없습니다.')">삭제</button>-->
                            <!--                            </form>-->
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- Delete Button -->
                <div th:if="${!lines.empty}">
                    <button id="deleteSelected" class="button delete">선택 삭제</button>
                </div>

                <!-- No results message -->
                <div th:if="${lines.empty}" class="no-results">
                    <p>검색 결과가 없습니다.</p>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination" th:if="${!lines.empty}">
                    <button th:if="${lines.hasPrevious()}"
                            th:onclick="'location.href=\'' + @{/line/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${plans.number - 1})} + '\''">이전</button>

                    <th:block th:each="pageNumber : ${#numbers.sequence(0, lines.totalPages - 1)}">
                        <button th:text="${pageNumber + 1}"
                                th:class="${pageNumber == lines.number} ? 'active'"
                                th:onclick="'location.href=\'' + @{/line/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${pageNumber})} + '\''"></button>
                    </th:block>

                    <button th:if="${lines.hasNext()}"
                            th:onclick="'location.href=\'' + @{/line/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${lines.number + 1})} + '\''">다음</button>
                </div>

                <!-- 생산라인 입력 폼 -->
                <div class="form-container">
                    <div class="section-title">생산라인 입력</div>
                    <form th:action="@{/line/create}" method="post" enctype="multipart/form-data">
                        <div class="form-row">
                            <label for="ProductionLineName">라인명 선택:</label>
                            <select id="ProductionLineName" name="ProductionLineName" class="dropdown" required>
                                <option value="">라인명</option>
                                <option value="생산 라인 1">생산 라인 1</option>
                                <option value="생산 라인 2">생산 라인 2</option>
                                <option value="생산 라인 3">생산 라인 3</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="location">설치 위치 선택:</label>
                            <select id="location" name="location" class="dropdown" required>
                                <option value="">위치</option>
                                <option value="1층">1층</option>
                                <option value="2층">2층</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="manager">담당자:</label>
                            <input type="text" id="manager" name="manager" value="홍길동" required>
                        </div>

                        <div class="form-row">
                            <label for="capacity">용량:</label>
                            <input type="text" id="capacity" name="capacity" value="1000" required>
                        </div>

                        <div class="form-row">
                            <label for="equipment">설비 정보:</label>
                            <input type="text" id="equipment" name="equipment" value="" required>
                        </div>

                        <div class="form-row">
                            <label for="todayQty">금일 목표 수량:</label>
                            <input type="text" id="todayQty" name="todayQty" value="1000" required>
                        </div>

                        <div class="form-row">
                            <label>상태:</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="statusNormal" name="productionLineStatus" value="NORMAL">
                                    <label for="statusNormal">NORMAL</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="statusDefected" name="productionLineStatus" value="DEFECTED">
                                    <label for="statusDefected">DEFECTED</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="button">저장</button>
                            <button type="button" class="button">취소</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 수정 창 (모달) -->
<div id="modifyLineModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>생산라인 수정</h2>
        <!-- 수정 폼 -->
        <form id="modifyLineForm" th:action="@{/line/modify}" method="post" enctype="multipart/form-data">
            <input type="hidden" id="modifyProductionLineCode" name="productionLineCode">
            <div class="form-row">
                <label for="modifyProductionLineName">라인명 선택:</label>
                <select id="modifyProductionLineName" name="modifyProductionLineName" class="dropdown" required>
                    <option value="">라인명</option>
                    <option value="생산 라인 1">생산 라인 1</option>
                    <option value="생산 라인 2">생산 라인 2</option>
                    <option value="생산 라인 3">생산 라인 3</option>
                </select>
            </div>

            <div class="form-row">
                <label for="modifyLocation">설치 위치 선택:</label>
                <select id="modifyLocation" name="modifyLocation" class="dropdown" required>
                    <option value="">위치</option>
                    <option value="1층">1층</option>
                    <option value="2층">2층</option>
                </select>
            </div>

            <div class="form-row">
                <label for="modifyManager">담당자:</label>
                <input type="text" id="modifyManager" name="manager" required>
            </div>

            <div class="form-row">
                <label for="modifyCapacity">용량:</label>
                <input type="text" id="modifyCapacity" name="capacity" required>
            </div>

            <div class="form-row">
                <label for="modifyEquipment">설비 정보:</label>
                <input type="text" id="modifyEquipment" name="equipment" required>
            </div>

            <div class="form-row">
                <label for="modifyTodayQty">금일 목표 수량:</label>
                <input type="text" id="modifyTodayQty" name="todayQty" required>
            </div>

            <div class="form-row">
                <label>상태:</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="modifyStatusNormal" name="lineStatus" value="NORMAL">
                        <label for="modifyStatusNormal">NORMAL</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="modifyStatusDefected" name="lineStatus" value="DEFECTED">
                        <label for="modifyStatusDefected">DEFECTED</label>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="button">수정</button>
                <button type="button" class="button" onclick="closeModal()">취소</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    $(document).ready(function() {
        // Set initial sort indicator
        var urlParams = new URLSearchParams(window.location.search);
        var currentSort = urlParams.get('sort');
        var currentDirection = urlParams.get('direction');
        if (currentSort && currentDirection) {
            $('th[data-column="' + currentSort + '"]').addClass(currentDirection.toLowerCase());
        }

       // 모든 체크박스 선택
       $("#selectAll").click(function(){
           $("input[name='selectedLine']").prop('checked', $(this).prop('checked'));
       });

       // 선택된 행 삭제
       $("#deleteSelected").click(function(e) {
           e.preventDefault();
           var selectedLines = $("input[name='selectedLine']:checked").map(function(){
               return $(this).val();
           }).get();

           if (selectedLines.length === 0) {
               alert("선택된 항목이 없습니다.");
               return;
           }

           if (confirm("정말 삭제하시겠습니까?")) {
               selectedLines.forEach(function(productionLineCode) {
                   // Perform AJAX request for each selected productionLineCode
                   $.ajax({
                       type: "POST",
                       url: "/line/delete/" + productionLineCode,
                       success: function(response) {
                           // Handle success (e.g., remove row from table)
                           console.log("Deleted line with CODE: " + productionLineCode);
                           // Find the row and remove it.  Requires you to add an CODE to each row
                           $('input[value="' + productionLineCode + '"]').closest('tr').remove();

                           // Optionally reload the page, or update a count
                           // window.location.reload();  // Simple reload
                       },
                       error: function(error) {
                           // Handle error
                           alert("삭제 중 오류 발생: " + error.responseText);
                       }
                   });
               });
               // Optionally, display a single success message after all deletions are attempted
               alert("선택된 항목이 삭제되었습니다.");
           }
       });

        // 항목 정렬 기능
        $('.sortable').click(function() {
            var column = $(this).data('column');
            var currentOrder = 'asc'; // Default to ascending if not sorted

            // Check if this column is already being sorted
            if ($(this).hasClass('asc')) {
                currentOrder = 'asc';
            } else if ($(this).hasClass('desc')) {
                currentOrder = 'desc';
            }

            // Remove sorting classes from all headers
            $('.sortable').removeClass('asc desc');

            // Toggle the order
            var newOrder = (currentOrder === 'asc') ? 'desc' : 'asc';

            // Add sorting class to clicked header
            $(this).addClass(newOrder);

            // Get current URL parameters
            var urlParams = new URLSearchParams(window.location.search);

            // Update or add sort and direction parameters
            urlParams.set('sort', column);
            urlParams.set('direction', newOrder.toUpperCase());

            // Redirect to the new URL with updated parameters
            window.location.href = window.location.pathname + '?' + urlParams.toString();
        });
    });

   // 생산계획 수정 창 열기 & 닫기 함수
   /*<![CDATA[*/
   function openModifyModal(productionLineCode) {
       var modal = document.getElementById("modifyLineModal");
       modal.style.display = "block";

       // AJAX call to fetch plan details based on productionLineCode
       $.ajax({
           url: '/line/getline/' + productionLineCode, // Replace with your actual endpoint
           type: 'GET',
           success: function(data) {
               // Populate the modal form fields with the retrieved data
               $('#modifyProductionLineCode').val(data.productionLineCode);
               // Find the option with the matching value and set it as selected
               $('#modifyProductionLineName option[value="' + data.productionLineName + '"]').prop('selected', true);
               $('#modifyLocation').val(data.modifyLocation);
               $('#modifyManager').val(data.manager);
               $('#modifyCapacity').val(data.capacity);
               $('#modifyEquipment').val(data.equipment);
               $('#modifyTodayQty').val(data.todayQty);
               $('#modifyProductionLineStatus').val(data.productionLineStatus);
               // ... populate other fields as necessary

               // Show the modal
               modal.style.display = "block";
           },
           error: function(error) {
               console.error('Error fetching plan details:', error);
               alert('Error fetching plan details.');
           }
       });

       var span = document.getElementsByClassName("close")[0];
       span.onclick = function() {
           modal.style.display = "none";
       }

       window.onclick = function(event) {
           if (event.target == modal) {
               modal.style.display = "none";
           }
       }
   }

   function closeModal() {
        var modal = document.getElementById("modifyLineModal");
        modal.style.display = "none";
    }
   /*]]>*/
</script>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script th:src="@{/js/scripts.js}"></script>
<th:block layout:fragment="script"></th:block>
<script>
    // Toggle Menu버튼 클릭 처리
    document.querySelector("#sidebarToggle").addEventListener("click", function (e){
        e.preventDefault();
        e.stopPropagation();

        if (document.body.classList.contains('sb-sidenav-toggled')) {
            document.body.classList.remove('sb-sidenav-toggled');
        } else {
            document.body.classList.add('sb-sidenav-toggled');
        }
    },false);
</script>
</body>
</html>
