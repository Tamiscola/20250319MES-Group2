<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반도체 생산계획 관리</title>

    <!-- Favicon and Styles from Original Layout -->
    <link rel="icon" type="image/x-icon" th:href="@{/assets/favicon.ico}" />
    <link th:href="@{/css/styles.css}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar-->
    <div class="border-end bg-light" id="sidebar-wrapper" style="background-color: #e3f2fd !important;">
        <div class="sidebar-heading border-bottom custom-sidebar-heading" style="text-align: center; height: 10vh;">
            <a class="a-tag" th:href="@{/bio/dashboard}"><h1>SemiCon</h1></a>
        </div>
        <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action list-group-item-light p-3"
               th:href="@{/bio/Employeeslist}">사원관리</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" th:href="@{/bio/bioProductList}">제품관리</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="#!">Events</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" th:href="@{/bio/BioInvShippinglist}">출고관리</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="#!">Profile</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="#!">Status</a>
            <div th:if="${isAdmin}">
                <a class="list-group-item list-group-item-action list-group-item-light p-3" th:onclick="location.href='/bio/admin'">관리자 페이지</a>
            </div>

            <div class="company-information">
                <p><b>Bio One</b></p>
                <p><b>경기도 성남시 분당구 190번길 45</b></p>
                <p><b>Tel : 031-250-8900</b></p>
                <p><b>Fax : 031-250-8901</b></p>
                <p><b>사업자등록번호 : 111-23-45678</b></p>
            </div>
        </div>
    </div>
    <!-- Page content wrapper-->
    <div id="page-content-wrapper">
        <!-- Top navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <!--<button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>-->

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                    </ul>
                </div>
                <!-- login 관련 추가 -->
                <div class="loginInfo">
                    <div class="login" th:if="${user == null}">
                        <button th:onclick="location.href='/bio/login'">로그인</button>
                    </div>
                    <div class="logout" th:unless="${user == null}">
                        <h6>[[${employeeName}]]님 환영합니다.</h6>
                        <button th:onclick="location.href='/bio/logout'">로그아웃</button>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Page content-->
        <!-- Integrated Production Plan Content -->
        <div class="container-fluid" layout:fragment="content">
            <div class="container">
                <!-- 생산계획 목록 섹션 -->
                <div class="section-title">생산계획 목록</div>

                <!-- 검색 및 필터 영역 -->
                <form th:action="@{/plan/search}" method="get" class="search-bar">
                    <label for="search">검색:</label>
                    <input type="text" id="search" name="keyword" placeholder="검색어 입력" th:value="${keyword}">

                    <select name="priority" class="dropdown">
                        <option value="">우선순위 ▼</option>
                        <option value="HIGH" th:selected="${selectedPriority == 'HIGH'}">높음</option>
                        <option value="NORMAL" th:selected="${selectedPriority == 'NORMAL'}">보통</option>
                        <option value="LOW" th:selected="${selectedPriority == 'LOW'}">낮음</option>
                    </select>

                    <select name="status" class="dropdown">
                        <option value="">상태 ▼</option>
                        <option value="STANDBY" th:selected="${selectedStatus == 'STANDBY'}">대기</option>
                        <option value="IN_PROGRESS" th:selected="${selectedStatus == 'IN_PROGRESS'}">진행 중</option>
                        <option value="COMPLETED" th:selected="${selectedStatus == 'COMPLETED'}">완료</option>
                    </select>

                    <button type="submit" class="button">검색</button>
                </form>

                <!-- 생산계획 테이블 -->
                <table th:if="${!plans.empty}">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>제품명</th>
                        <th>생산라인</th>
                        <th>생산기간</th>
                        <th>목표수량</th>
                        <th>담당자</th>
                        <th>우선순위</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="plan, iterStat : ${plans.content}">
                        <td th:text="${iterStat.count + (plans.number * plans.size)}"></td>
                        <td><span th:text="${plan.productName}"></span></td>
                        <td th:text="${plan.productionLineNames != null ? #strings.setJoin(plan.productionLineNames, ', ') : ''}"></td>
                        <td th:text="${#temporals.format(plan.startDate, 'yyyy-MM-dd')} + ' - ' + ${#temporals.format(plan.endDate, 'yyyy-MM-dd')}"></td>
                        <td th:text="${plan.targetQty}"></td>
                        <td th:text="${plan.manager}"></td>
                        <td th:text="${plan.priority}"></td>
                        <td th:text="${plan.planStatus}"></td>
                        <td class="action-btn">
                            <button class="button" th:onclick="'openModifyModal(\'' + ${plan.planId} + '\')'">수정</button>
                            <form th:action="@{/plan/delete/{id}(id=${plan.planId})}" method="post" style="display: inline;">
                                <button type="submit" class="button delete"
                                        onclick="return confirm('정말 삭제하시겠습니까? 삭제된 데이터는 복구할 수 없습니다.')">삭제</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- No results message -->
                <div th:if="${plans.empty}" class="no-results">
                    <p>검색 결과가 없습니다.</p>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination" th:if="${!plans.empty}">
                    <button th:if="${plans.hasPrevious()}"
                            th:onclick="'location.href=\'' + @{/plan/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${plans.number - 1})} + '\''">이전</button>

                    <th:block th:each="pageNumber : ${#numbers.sequence(0, plans.totalPages - 1)}">
                        <button th:text="${pageNumber + 1}"
                                th:class="${pageNumber == plans.number} ? 'active'"
                                th:onclick="'location.href=\'' + @{/plan/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${pageNumber})} + '\''"></button>
                    </th:block>

                    <button th:if="${plans.hasNext()}"
                            th:onclick="'location.href=\'' + @{/plan/search(keyword=${keyword},priority=${selectedPriority},status=${selectedStatus},page=${plans.number + 1})} + '\''">다음</button>
                </div>

                <!-- 생산계획 입력 폼 -->
                <div class="form-container">
                    <div class="section-title">생산계획 입력</div>
                    <form th:action="@{/plan/create}" method="post" enctype="multipart/form-data">
                        <div class="form-row">
                            <label for="productName">제품 선택:</label>
                            <select id="productName" name="productName" class="dropdown" required>
                                <option value="">제품을 선택하세요</option>
                                <option value="14nm FinFET Chip">14nm FinFET Chip</option>
                                <option value="5nm AI Processor">5nm AI Processor</option>
                                <option value="7nm Automotive SoC">7nm Automotive SoC</option>
                                <option value="3nm High-Performance Computing Chip">3nm High-Performance Computing Chip</option>
                                <option value="10nm IoT Sensor Chip">10nm IoT Sensor Chip</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="startDate">생산 시작일:</label>
                            <input type="date" id="startDate" name="startDate" pattern="yyyy-MM-dd" required>
                        </div>

                        <div class="form-row">
                            <label for="endDate">생산 종료일:</label>
                            <input type="date" id="endDate" name="endDate" pattern="yyyy-MM-dd" required>
                        </div>

                        <div class="form-row">
                            <label for="targetQty">목표 수량:</label>
                            <input type="number" id="targetQty" name="targetQty" value="1000" required>
                        </div>

                        <div class="form-row">
                            <label for="manager">생산 책임 담당자:</label>
                            <input type="text" id="manager" name="manager" value="홍길동" required>
                        </div>

                        <div class="form-row">
                            <label>우선순위:</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="priorityLow" name="priority" value="LOW">
                                    <label for="priorityLow">낮음</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="priorityMedium" name="priority" value="NORMAL">
                                    <label for="priorityMedium">보통</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="priorityHigh" name="priority" value="HIGH" checked>
                                    <label for="priorityHigh">높음</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <label for="productionLineName">생산 라인:</label>
                            <select id="productionLineName" name="productionLineName" class="dropdown" required>
                                <option value="">생산 라인을 선택하세요</option>
                                <option value="생산 라인 1">생산 라인 1</option>
                                <option value="생산 라인 2">생산 라인 2</option>
                                <option value="생산 라인 3">생산 라인 3</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label>상태:</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="statusWaiting" name="planStatus" value="STANDBY" checked>
                                    <label for="statusWaiting">대기</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="statusInProgress" name="planStatus" value="IN_PROGRESS">
                                    <label for="statusInProgress">진행 중</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="statusCompleted" name="planStatus" value="COMPLETED">
                                    <label for="statusCompleted">완료</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <label for="file">파일 업로드:</label>
                            <input type="file" id="file" name="file">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="button">저장</button>
                            <button type="button" class="button">취소</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 생산계획 수정 창 -->
<div id="modifyPlanModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>생산계획 수정</h2>
        <form id="modifyPlanForm" th:action="@{/plan/modify}" method="post" enctype="multipart/form-data">
            <input type="hidden" id="modifyPlanId" name="planId">
            <!-- Copy the form fields from the create form, but use different IDs -->
            <div class="form-row">
                <label for="modifyProductName">제품 선택:</label>
                <select id="modifyProductName" name="productName" class="dropdown" required>
                    <option value="">제품을 선택하세요</option>
                    <option value="14nm FinFET Chip">14nm FinFET Chip</option>
                    <option value="5nm AI Processor">5nm AI Processor</option>
                    <option value="7nm Automotive SoC">7nm Automotive SoC</option>
                    <option value="3nm High-Performance Computing Chip">3nm High-Performance Computing Chip</option>
                    <option value="10nm IoT Sensor Chip">10nm IoT Sensor Chip</option>
                </select>
            </div>

            <div class="form-row">
                <label for="modifyStartDate">생산 시작일:</label>
                <input type="date" id="modifyStartDate" name="startDate" pattern="yyyy-MM-dd" required>
            </div>

            <div class="form-row">
                <label for="modifyEndDate">생산 종료일:</label>
                <input type="date" id="modifyEndDate" name="endDate" pattern="yyyy-MM-dd" required>
            </div>

            <div class="form-row">
                <label for="modifyTargetQty">목표 수량:</label>
                <input type="number" id="modifyTargetQty" name="targetQty" required>
            </div>

            <div class="form-row">
                <label for="modifyManager">생산 책임 담당자:</label>
                <input type="text" id="modifyManager" name="manager" required>
            </div>

            <div class="form-row">
                <label>우선순위:</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="modifyPriorityLow" name="priority" value="LOW">
                        <label for="modifyPriorityLow">낮음</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="modifyPriorityMedium" name="priority" value="NORMAL">
                        <label for="modifyPriorityMedium">보통</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="modifyPriorityHigh" name="priority" value="HIGH">
                        <label for="modifyPriorityHigh">높음</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="modifyProductionLineName">생산 라인:</label>
                <select id="modifyProductionLineName" name="productionLineName" class="dropdown" required>
                    <option value="">생산 라인을 선택하세요</option>
                    <option value="생산 라인 1">생산 라인 1</option>
                    <option value="생산 라인 2">생산 라인 2</option>
                    <option value="생산 라인 3">생산 라인 3</option>
                </select>
            </div>

            <div class="form-row">
                <label>상태:</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="modifyStatusWaiting" name="planStatus" value="STANDBY">
                        <label for="modifyStatusWaiting">대기</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="modifyStatusInProgress" name="planStatus" value="IN_PROGRESS">
                        <label for="modifyStatusInProgress">진행 중</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="modifyStatusCompleted" name="planStatus" value="COMPLETED">
                        <label for="modifyStatusCompleted">완료</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="modifyFile">파일 업로드:</label>
                <input type="file" id="modifyFile" name="file">
            </div>

            <div class="form-actions">
                <button type="submit" class="button">수정</button>
                <button type="button" class="button" onclick="closeModal()">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script th:src="@{/js/scripts.js}"></script>
<th:block layout:fragment="script"></th:block>
<script>
    // Toggle Menu버튼 클릭 처리
    document.querySelector("#sidebarToggle").addEventListener("click", function (e){
        e.preventDefault();
        e.stopPropagation();

        if (document.body.classList.contains('sb-sidenav-toggled')) {
            document.body.classList.remove('sb-sidenav-toggled');
        } else {
            document.body.classList.add('sb-sidenav-toggled');
        }
    },false);

    // 생산계획 수정 창 열기 & 닫기 함수
    function openModifyModal(planId) {
        document.getElementById('modifyPlanModal').style.display = 'block';
        document.getElementById('modifyPlanId').value = planId;

        // Fetch plan details
        fetch('/plan/getplan/' + planId)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modifyProductName').value = data.productName;
                document.getElementById('modifyStartDate').value = data.startDate;
                document.getElementById('modifyEndDate').value = data.endDate;
                document.getElementById('modifyTargetQty').value = data.targetQty;
                document.getElementById('modifyManager').value = data.manager;
                document.querySelector('input[name="priority"][value="' + data.priority + '"]').checked = true;
                document.getElementById('modifyProductionLineName').value = data.productionLineNames[0];
                document.querySelector('input[name="planStatus"][value="' + data.planStatus + '"]').checked = true;
            })
            .catch(error => console.error('Error:', error));
    }

    function closeModal() {
        document.getElementById('modifyPlanModal').style.display = 'none';
    }

    // 바깥 창 누를 때 창 닫기
    window.onclick = function(event) {
        if (event.target == document.getElementById('modifyPlanModal')) {
            closeModal();
        }
    }
</script>
</body>
</html>
